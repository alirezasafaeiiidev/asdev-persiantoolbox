# ID: NP0-03

## Title

Feature availability framework (flags + consistent disabled UX/API)

## Status

DONE

## Context

Routes/pages/APIs currently have fragmented disabled behavior:

- multiple routes call `notFound()` (404),
- multiple APIs return 410 with mixed “v1.1.1/v2” wording,
- UI components link to disabled routes.

This undermines trust, breaks UX, and complicates rollout.

## Steps

1. Create a single feature availability module:
   - `isEnabled(feature)` (server + client safe)
   - `getDisabledMessage(feature, locale)`
2. Replace `notFound()` for feature-disabled routes with a consistent “disabled/coming soon” page:
   - correct `robots` policy (`noindex` if not live)
   - CTA to `/support` if relevant
3. Standardize API responses for disabled features:
   - consistent status code and JSON contract
4. Add contract tests:
   - no internal links to disabled routes when flag is off (or they render safely)

## Acceptance Criteria

- No user-visible “version mismatch” disable messaging.
- Disabled surfaces never hard-404 when linked internally.
- Enabling a feature flag makes the surface live without code edits.

## Dependencies

- None.

## Files to modify

- `app/*` (disabled pages)
- `app/api/*` (disabled endpoints)
- `components/features/monetization/*`
- `components/features/history/*`
- `ops/env/*.env.example`

## Implementation Notes

- Added a centralized feature availability registry (`lib/features/availability.ts`) with helpers for metadata, safe hrefs, and standardized disabled API payloads.
- Introduced shared disabled surface UI (`components/features/availability/FeatureDisabledPage.tsx`) and wired previously 404 routes (support, ads, plans, account, developers, subscription roadmap, admin, checkout, dashboard) to flags.
- Standardized disabled API responses across auth, history, subscription, and admin site-settings routes via `disabledApiResponse`.
- Updated monetization components to consume safe feature hrefs, preventing dead links when features are off.

## Verification

- `pnpm vitest --run tests/unit/feature-availability.test.ts tests/unit/disabled-api-contract.test.ts tests/unit/subscription-webhook.test.ts`

## Files Changed

- `lib/features/availability.ts`
- `lib/server/feature-flags.ts`
- `components/features/availability/FeatureDisabledPage.tsx`
- `app/*` disabled feature routes
- `app/api/*` disabled endpoints
- `components/features/monetization/*`
- `tests/unit/feature-availability.test.ts`
- `tests/unit/disabled-api-contract.test.ts`
