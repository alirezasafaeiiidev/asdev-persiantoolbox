# ID: NP0-06

## Title

Multi-instance readiness for settings/auth/session storage

## Status

DONE

## Context

At 100k DAU, you may need horizontal scaling. Current state includes:

- SQLite settings storage via `node:sqlite` DatabaseSync (`lib/server/siteSettings.ts`)
- Postgres session/subscription modules exist but app routes are disabled

This needs a clear “single-host vs multi-host” decision and migrations.

## Steps

1. Decide deployment model:
   - single VPS (stateful disk OK), OR
   - multi-instance (state must move to DB/object storage)
2. If multi-instance:
   - move site settings from SQLite to Postgres (table + admin APIs)
   - ensure sessions/auth (if enabled) are DB-backed and consistent
3. Add a scaling doc with explicit invariants (what must be shared).

## Acceptance Criteria

- Settings/auth/session persistence matches the chosen scaling model.
- No silent split-brain behavior when running multiple instances.

## Dependencies

- Database availability if moving state to DB.

## Files to modify

- `lib/server/siteSettings.ts`
- `lib/server/sessions.ts`
- `lib/server/db.ts`
- `scripts/db/schema.sql`
- `docs/deployment/*`

## Implementation Notes

- Finalized deployment decision as `single-vps-stateful` for current release train.
- Documented scaling invariants and explicit multi-instance upgrade path in `docs/deployment/scaling-model.md`.
- Current storage split is now explicit: SQLite for site settings on single host, Postgres for session/auth/subscription/history modules.

## Verification

- `pnpm ci:contracts`
- `pnpm gate:local-first`
