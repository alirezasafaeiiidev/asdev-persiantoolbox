# PTB-ARC-001 — معماری Local‑First (سیاست و پیاده‌سازی)

## هدف
تضمین اینکه اپ در شرایط:
- عدم دسترسی به اینترنت جهانی
- تحریم/CDN بلاک
- سرعت پایین
**همچنان قابل استفاده** باشد و هیچ وابستگی خارجی runtime نداشته باشد.

## خروجی مورد انتظار
- یک سند سیاست Local‑First (این فایل)
- یک گیت CI که نقض‌ها را fail می‌کند
- قوانین caching سرویس‌ورکر برای مسیرهای آفلاین و مسیرهای Online‑Required

## سیاست (Policy)
1) **Runtime بدون Third‑Party**: هیچ درخواست مستقیم به دامنه خارجی از کلاینت مجاز نیست.
2) **Same‑Origin First**: هر داده/سرویس خارجی فقط از طریق endpoint های دامنه خود پروژه مصرف می‌شود.
3) **Offline UX**: برای مسیرهای آفلاین باید fallback مشخص وجود داشته باشد.
4) **Tool Tiering**: هر ابزار باید یکی از سطوح زیر را داشته باشد:
   - Offline‑Guaranteed
   - Offline‑Capable (Hybrid)
   - Online‑Required

## طراحی سطوح ابزار
### 1) Offline‑Guaranteed
- تمام منطق و داده‌ها در کلاینت یا assets داخلی است.
- route باید در Shell cache سرویس‌ورکر قرار گیرد.

### 2) Offline‑Capable (Hybrid)
- کلاینت فقط از `GET /api/data/<tool>` داده می‌گیرد (same‑origin).
- سرور داده را از cache داخلی برمی‌گرداند.
- اگر cache قدیمی شد: `meta.stale=true` و تاریخ آخرین بروزرسانی به UI منتقل شود.
- اگر داده نداریم: ابزار باید با پیام توقف کنترل‌شده از کار بیفتد.

### 3) Online‑Required
- مسیرها Network‑Only.
- سرویس‌ورکر نباید این مسیرها را cache کند.
- UI در حالت آفلاین باید صفحه “نیازمند اینترنت” نمایش دهد.

## معیار پذیرش
- در حالت Airplane Mode (موبایل) ابزارهای Offline‑Guaranteed بدون خطا کار کنند.
- هیچ درخواست خارجی در DevTools Network دیده نشود (به جز دامنه خود پروژه).
- مسیرهای Online‑Required در حالت آفلاین پیام استاندارد نمایش دهند.
